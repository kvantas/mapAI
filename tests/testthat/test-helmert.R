test_that("helmert model in train_pai_model returns a valid object", {
  withr::with_tempdir({
    demo_files <- create_demo_data(output_dir = ".")
    gcp_data <- read_gcps(gcp_path = demo_files$gcp_path, crs = 3857)

    # Train the model using the GCPs generated by create_demo_data()
    helmert_model <- train_pai_model(gcp_data, pai_method = "helmert")

    # Check the class and structure
    expect_s3_class(helmert_model, "pai_model")
    expect_s3_class(helmert_model$model, "helmert")
    expect_named(helmert_model$model$coefficients, c("a", "b"))
  })
})

test_that("Full apply_pai_model workflow works for helmert method with demo data", {
  withr::with_tempdir({
    demo_files <- create_demo_data(output_dir = ".")
    gcp_data <- read_gcps(gcp_path = demo_files$gcp_path, crs = 3857)
    map_to_correct <- read_map(shp_path = demo_files$shp_path)

    # This is a full integration test using the demo data

    # 1. Train the helmert model
    helmert_model <- train_pai_model(gcp_data, pai_method = "helmert")

    # 3. Apply the correction to the map
    corrected_map <- apply_pai_model(pai_model = helmert_model, map = map_to_correct)

    expect_s3_class(corrected_map , "sf")
  })
})

# This test remains the same as it tests a specific failure condition
# that cannot be generated by create_demo_data().
test_that("helmert method handles co-located source points gracefully", {
  bad_gcps_df <- data.frame(source_x = c(10, 10), source_y = c(20, 20),
                            target_x = c(1, 2), target_y = c(1, 2))
  bad_gcps_sf <- read_gcps(gcp_path={f<-tempfile(fileext=".csv");write.csv(bad_gcps_df,f,row.names=F);f}, crs=3857)

  expect_error(
    train_pai_model(bad_gcps_sf, pai_method = "helmert"),
    "Cannot solve Helmert transformation: source points are co-located."
  )
})
